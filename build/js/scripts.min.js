var puzzlesApp=angular.module("puzzlesApp",["ngRoute"]).config(["$routeProvider",function(e){e.when("/menu",{templateUrl:"views/menu.html",controller:"MenuController"}),e.when("/gameOptions",{templateUrl:"views/gameOptions.html",controller:"GameOptionsController"}),e.when("/game",{templateUrl:"views/game.html",controller:"GameController"}),e.otherwise({redirectTo:"/menu"})}]).run(["$rootScope","$templateCache",function(e,n){e.$on("$routeChangeStart",function(e,t,o){void 0!==o&&n.remove(o.templateUrl)})}]);puzzlesApp.controller("GameController",["$scope","$location","$compile","$q","puzzlesService",function(l,e,t,o,a){l.heightCell=480/a.getVerticalAmount(),l.widthCell=480/a.getHorizontalAmount(),l.puzzles=new Array(a.getHorizontalAmount()*a.getVerticalAmount()),l.message="Puzzle is solved";var n=a.getPuzzles();if(l.positions=a.getPositions(),0===l.positions.length){for(var s=0;s<l.puzzles.length;s++){var i={};i.id=s,i.val=n[s],l.puzzles[s]=i}p(l.puzzles),a.savePositions(l.puzzles)}l.puzzles=l.positions,l.restart=function(){l.isSolved=!1,p(l.puzzles),a.savePositions(l.puzzles)},l.goToMenu=function(){e.path("/menu")},l.isSolved=u();var r={};function u(){for(var e=0;e<l.puzzles.length;e++)if(l.puzzles[e].id!==e)return!1;return!0}function p(e){for(var t=e.length-1;0<t;t--){var o=Math.floor(Math.random()*(t+1)),n=e[t];e[t]=e[o],e[o]=n}}l.drag=function(e){if(!l.isSolved&&0===Object.keys(r).length){r.elem=e.target;var t=(s=r.elem,{top:(i=s.getBoundingClientRect()).top+pageYOffset,left:i.left+pageXOffset});r.originalLeft=t.left,r.originalTop=t.top;var o=e.pageX-r.originalLeft,n=e.pageY-r.originalTop;angular.element(r.elem).on("mousemove",function(e){r.elem.style.zIndex=999,r.elem.style.position="absolute",r.elem.style.left=e.pageX-o+"px",r.elem.style.top=e.pageY-n+"px"}),angular.element(r.elem).on("mouseup",function(e){if(angular.element(r.elem).off("mousemove"),r.elem.style.zIndex=1,selectedElem=function(e){r.elem.style.visibility="hidden";var t=document.elementFromPoint(e.clientX,e.clientY);if(r.elem.style.visibility="visible",t.closest(".droppable"))return t;return null}(e),selectedElem&&selectedElem.classList.contains("draggable")){r.elem.style.left=selectedElem.style.left,r.elem.style.top=selectedElem.style.top;var t=r.elem.getAttribute("data-position"),o=selectedElem.getAttribute("data-position");n=t,s=o,i=l.puzzles[n],l.puzzles[n]=l.puzzles[s],l.puzzles[s]=i,a.savePositions(l.puzzles),l.isSolved=u(),l.$apply()}else r.elem.style.left=r.originalLeft+"px",r.elem.style.top=r.originalTop+"px";var n,s,i;r={}})}var s,i}}]),puzzlesApp.controller("GameOptionsController",["$scope","$location","puzzlesService","imageCrop",function(t,o,n,e){t.optionsAmount=[9,16,25],t.pics=["./images/img1.jpg","./images/img2.jpeg"],t.selectedImage=t.pics[0],t.selectedAmount=9,t.start=function(){e.cutImage(Math.sqrt(t.selectedAmount),Math.sqrt(t.selectedAmount),t.selectedImage).then(function(e){n.savePuzzles(e),n.saveOptions(Math.sqrt(t.selectedAmount),Math.sqrt(t.selectedAmount)),n.clearPositions(),o.path("/game")})}}]),puzzlesApp.controller("MenuController",["$scope","$location","puzzlesService",function(e,t,o){e.savedGameExists=!1,0!==o.getPositions().length&&(e.savedGameExists=!0),e.startNewGame=function(){o.clearPositions(),t.path("/gameOptions")},e.loadGame=function(){t.path("/game")}}]),puzzlesApp.service("imageCrop",["$q",function(t){this.cutImage=function(a,r,e){var u=t.defer(),o=new Image;return o.src=e,o.onload=function(){var e=o.width/o.height,t=document.getElementById("canvasResize");o.width<o.height?(t.width=480,t.height=480/e):(t.height=480,t.width=480*e),t.getContext("2d").drawImage(o,0,0,t.width,t.height),resizedImageSrc=t.toDataURL("image/jpeg",1);var l=new Image;l.src=resizedImageSrc,l.onload=function(){for(var e=[],t=480/a,o=480/r,n=0;n<a;n++)for(var s=0;s<r;s++){var i=document.getElementById("canvas");i.width=t,i.height=o,i.getContext("2d").drawImage(l,s*t,n*o,t,o,0,0,i.width,i.height),e.push(i.toDataURL("image/jpeg",1))}u.resolve(e)}},u.promise}}]),puzzlesApp.service("puzzlesService",["$window",function(e){var t=sessionStorage.getItem("options"),o=t?JSON.parse(t):[],n=sessionStorage.getItem("positions"),s=n?JSON.parse(n):[],i=sessionStorage.getItem("puzzles"),l=i?JSON.parse(i):[];function a(){sessionStorage.setItem("positions",JSON.stringify(s))}this.saveOptions=function(e,t){0!=o.length&&(o=[]),o.push({horizontalAmount:e,verticalAmount:t}),sessionStorage.setItem("options",JSON.stringify(o))},this.getHorizontalAmount=function(){return o[0].horizontalAmount},this.getVerticalAmount=function(){return o[0].verticalAmount},this.getPuzzles=function(){return l},this.savePositions=function(e){0!=s.length&&(s=[]),s=e,a()},this.savePuzzles=function(e){0!=l.length&&(l=[]),l=e,sessionStorage.setItem("puzzles",JSON.stringify(l))},this.getPositions=function(){return s},this.clearPositions=function(){s=[]}}]);